package shared;

import java.io.IOException;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.stream.Collectors;

import components.Utilities;
import models.InitialRowValues;
import models.Link;
import models.Model;
import models.ModelCdpp;
import models.Port;

public class Ma {

	private static ModelCdpp current;
	
	public static List<ModelCdpp> Parse(InputStream ma) throws IOException {
		ArrayList<ModelCdpp> models = new ArrayList<ModelCdpp>();
		ArrayList<Link> links = new ArrayList<Link>();
		ArrayList<String> ignore = new ArrayList<String>();
				
		Utilities.ReadFile(ma, (String l) -> {
			l = l.trim().toLowerCase();
			
			if (l.startsWith("[")) {
				String name = l.substring(1, l.length() - 1);
				
				if (ignore.contains(name)) return; 
				
				current = new ModelCdpp(name);
				
				models.add(current);
				
				return;
			}
			
			

			if (l.startsWith("components")) {
				// components : sender@Sender
				current.submodels.add(l.split("\\s|@")[2]);
			}

			else if (l.startsWith("link")) {
				// Link : dataOut@sender in1@Network
				String[] ports = l.split("\\s");
				String[] left = ports[2].split("@");
				String[] right = ports[3].split("@");
				
				Link link = new Link();
				
				link.modelA = left.length == 1 ? current.name : left[1];
				link.portA = left[0];
				link.portB = right[0];
				link.modelB = right.length == 1 ? current.name : right[1];
				
				links.add(link);
			}
			
			else if (l.startsWith("dim")) {
				String[] split = l.replaceAll("\\s+", "").split(":");
				String[] dim = split[1].substring(1, split[1].length() - 1).split(",");
				
				current.size = Arrays.stream(dim).mapToInt(i -> Integer.parseInt(i)).toArray();
				
				if (current.size.length == 2) current.size[2] = 1;
			}
			
			else if (l.startsWith("height")) current.size[0] = +d[1];
			
			else if (l.startsWith("width")) current.size[1] = +d[1];
			
			else if (l.startsWith("neighborports")) {
				List<String> ports = Arrays.asList(l.split(" "));
				
				current.ports = ports.stream()
									 .map(p -> new Port(p, "output"))
									 .collect(Collectors.toList());
			}
			
			else if (l.startsWith("initialvalue")) {
				current.initialValue = Float.parseFloat(l.split(" ")[2]);
			}
			
			else if (l.startsWith("initialrowvalue")) {
				InitialRowValues rv = new InitialRowValues();
				
				String[] split = l.split("\\s+");
				
				rv.row = Integer.parseInt(split[2]);
				
				List<Integer> values = new ArrayList<Integer>();
				
				for (int i = 0; i < split[3].length(); i++){
				    char c = split[3].charAt(i);        

					rv.values.add(Character.getNumericValue(c));
				}
				
				current.initialRowValues.add(rv);								
			}
			
			else if (l.startsWith("localtransition") || l.startsWith("zone")) {
				ignore.add(l.split("\\s")[2]);
			}
		});
		
		links.forEach((Link l) -> {
			Model mA = models.stream()
							 .filter((Model m) -> m.name.equals(l.modelA))
							 .findFirst()
							 .orElse(null);
			
			Port pA = mA.ports.stream()
							  .filter((Port p) -> p.name.equals(l.portA))
							  .findFirst()
							  .orElse(null);
			
			if (pA == null) mA.ports.add(new Port(l.portA, "output"));
			
			Model mB = models.stream()
							 .filter((Model m) -> m.name.equals(l.modelB))
							 .findFirst()
							 .orElse(null);
			
			
			Port pB = mB.ports.stream()
							  .filter((Port p) -> p.name.equals(l.portB))
							  .findFirst()
							  .orElse(null);
			
			if (pB == null) mB.ports.add(new Port(l.portB, "input"));
			
			mA.links.add(new Link(l.modelA, l.portA, l.modelB, l.portB));
		});
		
		return models;
	}
	
	private static void ReadModelLine(String right) {
		
	}
}
